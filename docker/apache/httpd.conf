LoadModule headers_module modules/mod_headers.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so

# Basic hardening
ServerTokens Prod
ServerSignature Off
TraceEnable Off
FileETag None

# Request limits (tune as needed)
RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
LimitRequestBody 10485760

# Security headers (global)
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set Referrer-Policy "no-referrer-when-downgrade"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# HSTS only when HTTPS is actually used (works behind reverse proxies that set X-Forwarded-Proto)
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" "expr=%{req:X-Forwarded-Proto} == 'https'"

# Content Security Policy (adjust for your app)
Header always set Content-Security-Policy "default-src 'self'; img-src 'self' data:; object-src 'none'; base-uri 'self'; frame-ancestors 'self'; form-action 'self'"

# Cross-origin protections
Header always set Cross-Origin-Resource-Policy "same-origin"
Header always set Cross-Origin-Opener-Policy "same-origin"
# Optional: enable only if your app supports COEP
# Header always set Cross-Origin-Embedder-Policy "require-corp"

# Disable forward proxying
ProxyRequests Off
AllowEncodedSlashes NoDecode

# Only serve public directory
DocumentRoot "/var/www/html/public"
<Directory "/var/www/html/public">
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted

    # Execute only .php within public
    <FilesMatch "\.php$">
        SetHandler "proxy:fcgi://php:9000"
        Header always set Cache-Control "no-store"
    </FilesMatch>

    # Do not accept PATH_INFO by default (tighten unless your app needs it)
    ProxyFCGISetEnvIf "true" "proxy-fcgi-pathinfo=0"

    # Block hidden files and common sensitive extensions
    <FilesMatch "^\.|\.(env|ini|log|conf|yml|yaml|lock|json|md|sh)$">
        Require all denied
    </FilesMatch>

    # Optional: restrict methods
    <LimitExcept GET POST HEAD OPTIONS>
        Require all denied
    </LimitExcept>
</Directory>

# Defense-in-depth: never allow dot-dot traversal anywhere
<LocationMatch "\.\.">
    Require all denied
</LocationMatch>

# Never execute PHP in uploads
<Directory "/var/www/html/public/uploads">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
    Options -ExecCGI
</Directory>