worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server_tokens off;

    # Increase FastCGI header buffers to handle large Set-Cookie headers from Auth0 callback
    fastcgi_buffer_size 64k;
    fastcgi_buffers 16 32k;
    fastcgi_busy_buffers_size 64k;

    # Allow larger client request headers if needed
    large_client_header_buffers 4 16k;

    server {
        listen 80 default_server;
        server_name _;

        # Only serve public directory and never execute PHP outside it
        root /var/www/html/public;
        index index.php;

        # Security headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        # Block hidden files and sensitive extensions
        location ~ (^|/)[.] {
            deny all;
        }
        location ~* \.(env|ini|log|conf|yml|yaml|lock|json|md|sh)$ {
            deny all;
        }

        # Route all requests to front controller
        location / {
            try_files $uri /index.php$is_args$args;
        }

        location ~ \.php$ {
            include        fastcgi_params;
            fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param  PATH_INFO        $fastcgi_path_info;
            fastcgi_pass   php:9000;
            fastcgi_read_timeout 30s;
        }
    }
}


